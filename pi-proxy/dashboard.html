<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PROXY DASHBOARD</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0d0500;
      color: #ffa600;
      font-family: 'Share Tech Mono', monospace;
      font-size: 15px;
      line-height: 1.8;
      padding: 32px 28px;
      max-width: 520px;
      margin: 0 auto;
    }

    h1 { font-size: 16px; letter-spacing: 0.1em; margin-bottom: 4px; }
    .sub { color: #7a5200; font-size: 12px; margin-bottom: 24px; }
    hr { border: none; border-top: 1px solid #3a2500; margin: 20px 0; }
    .section-title { font-size: 11px; color: #7a5200; letter-spacing: 0.12em; margin-bottom: 10px; }

    /* ── Stat rows ── */
    .row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #1a0d00;
    }
    .label { color: #7a5200; }
    .value { color: #ffa600; }
    .value.green { color: #39ff6a; }
    .value.red   { color: #ff3030; }

    /* ── Hit rate bar ── */
    .bar-wrap { background: #1a0d00; height: 4px; margin: 12px 0 4px; }
    .bar-fill  { height: 100%; background: #ffa600; transition: width 0.5s; }
    .bar-sub   { font-size: 11px; color: #3a2500; margin-bottom: 4px; }

    /* ── Peak hour chart ── */
    .chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 64px;
      margin-bottom: 8px;
    }
    .ch-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 3px;
      height: 100%;
    }
    .ch-bar {
      width: 100%;
      background: #7a5200;
      min-height: 2px;
      transition: height 0.5s ease;
    }
    .ch-bar.now  { background: #ffa600; box-shadow: 0 0 6px rgba(255,166,0,0.5); }
    .ch-bar.peak { background: #39ff6a; box-shadow: 0 0 6px rgba(57,255,106,0.4); }
    .ch-label {
      font-size: 8px;
      color: #3a2500;
      white-space: nowrap;
    }
    .ch-label.now  { color: #ffa600; }
    .chart-legend {
      display: flex;
      gap: 16px;
      font-size: 10px;
      color: #3a2500;
      margin-bottom: 4px;
    }
    .chart-legend span { display: flex; align-items: center; gap: 5px; }
    .legend-dot {
      width: 7px; height: 7px; border-radius: 50%;
      display: inline-block;
    }
    .peak-summary {
      font-size: 11px;
      color: #7a5200;
      margin-top: 6px;
    }
    .peak-summary strong { color: #ffa600; }

    /* ── Buttons ── */
    .btn-row { display: flex; gap: 8px; margin-top: 24px; }
    button {
      flex: 1;
      background: none;
      border: 1px solid #ffa600;
      color: #ffa600;
      font-family: 'Share Tech Mono', monospace;
      font-size: 13px;
      padding: 10px;
      cursor: pointer;
      letter-spacing: 0.06em;
    }
    button:hover { background: rgba(255,166,0,0.08); }
    button.red { border-color: #ff3030; color: #ff3030; }
    button.red:hover { background: rgba(255,48,48,0.08); }

    /* ── Confirm ── */
    #confirm {
      display: none;
      margin-top: 16px;
      border: 1px solid #ff3030;
      padding: 16px;
      color: #ff3030;
      font-size: 13px;
      line-height: 2;
    }
    #confirm.show { display: block; }
    #confirm .btn-row { margin-top: 12px; }

    .footer { margin-top: 24px; font-size: 11px; color: #3a2500; }

    .dot {
      display: inline-block;
      width: 8px; height: 8px; border-radius: 50%;
      background: #39ff6a;
      margin-right: 8px;
      animation: pulse 2s ease-in-out infinite;
    }
    .dot.off { background: #ff3030; animation: none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  </style>
</head>
<body>

  <h1>OVERHEAD TRACKER</h1>
  <div class="sub">PI PROXY DASHBOARD</div>

  <div class="row">
    <span class="label">STATUS</span>
    <span class="value" id="status"><span class="dot"></span>CONNECTING...</span>
  </div>
  <div class="row">
    <span class="label">UPTIME</span>
    <span class="value" id="uptime">--</span>
  </div>

  <hr>

  <div class="row">
    <span class="label">TOTAL REQUESTS</span>
    <span class="value" id="total">--</span>
  </div>
  <div class="row">
    <span class="label">CACHE HITS</span>
    <span class="value green" id="hits">--</span>
  </div>
  <div class="row">
    <span class="label">CACHE MISSES</span>
    <span class="value" id="misses">--</span>
  </div>
  <div class="row">
    <span class="label">ERRORS</span>
    <span class="value" id="errors">--</span>
  </div>
  <div class="row">
    <span class="label">UNIQUE CLIENTS</span>
    <span class="value" id="clients">--</span>
  </div>

  <hr>

  <div class="section-title">CACHE HIT RATE</div>
  <div class="bar-wrap"><div class="bar-fill" id="hit-bar" style="width:0%"></div></div>
  <div class="bar-sub" id="rate">--%</div>

  <hr>

  <div class="section-title">REQUESTS BY HOUR</div>
  <div class="chart" id="chart"></div>
  <div class="chart-legend">
    <span><span class="legend-dot" style="background:#ffa600"></span>CURRENT</span>
    <span><span class="legend-dot" style="background:#39ff6a"></span>PEAK</span>
    <span><span class="legend-dot" style="background:#7a5200"></span>OTHER</span>
  </div>
  <div class="peak-summary" id="peak-summary"></div>

  <div class="btn-row">
    <button onclick="refresh()">REFRESH</button>
    <button class="red" onclick="document.getElementById('confirm').classList.toggle('show')">STOP PROXY</button>
  </div>

  <div id="confirm">
    THIS WILL TAKE THE API OFFLINE.<br>PM2 WILL RESTART IT AUTOMATICALLY.
    <div class="btn-row">
      <button onclick="document.getElementById('confirm').classList.remove('show')">CANCEL</button>
      <button class="red" onclick="doShutdown()">CONFIRM STOP</button>
    </div>
  </div>

  <div class="footer">AUTO-REFRESH IN <span id="countdown">10</span>S</div>

  <script>
    const API = 'https://api.overheadtracker.com';
    let t = 10;

    async function fetchStats() {
      try {
        const res = await fetch(API + '/stats', { signal: AbortSignal.timeout(6000) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch(e) { return null; }
    }

    async function fetchPeak() {
      try {
        const res = await fetch(API + '/peak', { signal: AbortSignal.timeout(6000) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch(e) { return null; }
    }

    function renderChart(peak) {
      const chart = document.getElementById('chart');
      chart.innerHTML = '';
      const max = Math.max(...peak.hours.map(h => h.count), 1);

      peak.hours.forEach(h => {
        const col  = document.createElement('div');
        col.className = 'ch-col';

        const bar  = document.createElement('div');
        const pct  = Math.max(2, (h.count / max) * 64);
        bar.style.height = pct + 'px';
        bar.className = 'ch-bar' +
          (h.current          ? ' now'  : '') +
          (h.hour === peak.peakHour && !h.current ? ' peak' : '');
        bar.title = h.label + ' — ' + h.count + ' requests';

        const lbl  = document.createElement('div');
        lbl.className = 'ch-label' + (h.current ? ' now' : '');
        // Only label every 6 hours to avoid crowding
        lbl.textContent = h.hour % 6 === 0 ? String(h.hour).padStart(2,'0') : '';

        col.appendChild(bar);
        col.appendChild(lbl);
        chart.appendChild(col);
      });

      // Summary line
      const s = document.getElementById('peak-summary');
      if (peak.total > 0) {
        s.innerHTML = 'PEAK HOUR <strong>' + peak.peakLabel + '</strong> — ' +
          peak.peakCount + ' REQUESTS &nbsp;·&nbsp; ' + peak.total + ' TOTAL';
      } else {
        s.textContent = 'NO DATA YET — ACCUMULATING...';
      }
    }

    async function refresh() {
      const [stats, peak] = await Promise.all([fetchStats(), fetchPeak()]);

      if (!stats) {
        document.getElementById('status').innerHTML = '<span class="dot off"></span>OFFLINE';
        return;
      }

      document.getElementById('status').innerHTML  = '<span class="dot"></span>ONLINE';
      document.getElementById('uptime').textContent  = stats.uptime;
      document.getElementById('total').textContent   = stats.totalRequests.toLocaleString();
      document.getElementById('hits').textContent    = stats.cacheHits.toLocaleString();
      document.getElementById('misses').textContent  = stats.cacheMisses.toLocaleString();
      document.getElementById('clients').textContent = stats.uniqueClients;

      const errEl = document.getElementById('errors');
      errEl.textContent = stats.errors;
      errEl.className = 'value ' + (stats.errors > 0 ? 'red' : 'green');

      const rate = parseFloat(stats.cacheHitRate);
      document.getElementById('rate').textContent    = stats.cacheHitRate;
      document.getElementById('hit-bar').style.width = rate + '%';

      if (peak) renderChart(peak);

      t = 10;
    }

    async function doShutdown() {
      document.getElementById('confirm').classList.remove('show');
      try { await fetch(API + '/shutdown', { signal: AbortSignal.timeout(4000) }); } catch(e) {}
      document.getElementById('status').innerHTML = '<span class="dot off"></span>STOPPING...';
      setTimeout(refresh, 5000);
    }

    setInterval(() => {
      t--;
      document.getElementById('countdown').textContent = t;
      if (t <= 0) refresh();
    }, 1000);

    refresh();
  </script>
</body>
</html>