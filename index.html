<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SYD Arrivals</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    body.dotmatrix {
      background: #1a0a00;
      color: #ff6600;
      font-family: 'Share Tech Mono', monospace;
      font-size: 1rem;
      padding: 20px;
      max-width: 520px;
      margin: 0 auto;
      box-sizing: border-box;
    }
    body.dotmatrix * { text-shadow: 0 0 2px #ff6600, 0 0 8px #ff4400; box-sizing: border-box; }
    body.dotmatrix::after {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 3px, rgba(0,0,0,0.18) 3px, rgba(0,0,0,0.18) 4px);
      pointer-events: none; z-index: 99;
    }
    body.dotmatrix hr { border-color: #ff6600; opacity: 0.3; margin: 12px 0; }
    body.dotmatrix #info { font-size: 1.1rem; margin: 16px 0 8px; line-height: 1.8; }
    body.dotmatrix #main { line-height: 2; margin-bottom: 16px; }
    body.dotmatrix #counter { margin: 0 8px; }
    body.dotmatrix #error { color: #ff2200; word-break: break-all; font-size: 0.85rem; }
    body.dotmatrix button {
      background: none; border: 1px solid #ff6600; color: #ff6600;
      font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;
      padding: 4px 10px; cursor: pointer; text-shadow: 0 0 6px #ff4400;
    }
    body.dotmatrix button:hover { background: #ff660022; }
    #dm-canvas { display: block; margin-top: 16px; width: 100%; height: auto; image-rendering: pixelated; }
    #dm-photo { display:block; width:100%; max-height:140px; object-fit:cover; object-position:center; margin-top:10px; opacity:0.85; }
    #dm-photo-credit { font-size:0.6rem; opacity:0.5; margin-top:2px; }
    #spinner { display:none; margin:8px 0; font-size:0.9rem; letter-spacing:2px; animation: pulse 1s step-end infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .nav-row { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .nav-row #counter { flex:1; text-align:center; }
    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:0} }
    @media (max-width: 480px) {
      body.dotmatrix { font-size: 0.9rem; padding: 14px; }
      body.dotmatrix #info { font-size: 1rem; }
      body.dotmatrix button { font-size: 0.78rem; padding: 4px 8px; }
    }
  </style>
</head>
<body class="dotmatrix">
  <div class="classic-layout">
    <p>SYD // SYDNEY KINGSFORD SMITH<br>ARRIVALS BOARD <span class="blink">█</span></p>
    <hr>
    <p id="error"></p>
    <div id="spinner">[ FETCHING ▪▪▪ ]</div>
    <p id="info">LOADING...</p>
    <p id="main"></p>
    <canvas id="dm-canvas" width="460" height="120"></canvas>
    <img id="dm-photo" style="display:none" alt="Aircraft photo">
    <p id="dm-photo-credit"></p>
    <hr>
    <div class="nav-row">
      <button onclick="prev()">&#9664; PREV</button>
      <span id="counter"></span>
      <button onclick="next()">NEXT &#9654;</button>
      <button onclick="go(0)">NOW</button>
    </div>
    <br>
    <span id="refresh-timer"></span>
  </div>

  <script>
    const SYD_LAT = -33.9461, SYD_LON = 151.1772;
    let flights = [], i = 0;

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Departure airport guess from ICAO callsign prefix
    const ORIGIN_MAP = {
      QFA:'MEL / BNE / PER / ADL', VOZ:'MEL / BNE / PER', JST:'MEL / BNE',
      TGW:'MEL / BNE', VTI:'MEL / PER', ANZ:'AKL / CHC / WLG',
      UAL:'LAX / SFO', DAL:'LAX', AAL:'LAX / DFW',
      CPA:'HKG', CES:'PVG / PEK', CSN:'CAN',
      SIA:'SIN', MAS:'KUL', THA:'BKK',
      EK:'DXB', QR:'DOH', EY:'AUH',
      BAW:'LHR', KAL:'ICN', ANA:'NRT / KIX',
      JAL:'NRT', PAL:'MNL', GIA:'CGK', MXD:'DPS',
    };

    function guessOrigin(callsign) {
      if (!callsign || callsign === '---') return null;
      for (let len = 4; len >= 2; len--) {
        const key = callsign.slice(0, len).toUpperCase();
        if (ORIGIN_MAP[key]) return ORIGIN_MAP[key];
      }
      return null;
    }

    // Draw descent profile canvas
    function drawProfile(canvasId, distKm, altFt, color, bgcolor, dimColor) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      canvas.width = canvas.offsetWidth || 460;
      const W = canvas.width, H = canvas.height;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = bgcolor;
      ctx.fillRect(0, 0, W, H);

      const PAD_L = 44, PAD_R = 10, PAD_T = 8, PAD_B = 22;
      const gW = W - PAD_L - PAD_R, gH = H - PAD_T - PAD_B;
      const tanG = Math.tan(3 * Math.PI / 180);
      const WINDOW_NM = 15;
      const distNm = distKm / 1.852;
      const xMinNm = Math.max(0, distNm - WINDOW_NM * 0.6);
      const xMaxNm = xMinNm + WINDOW_NM;
      const xMinKm = xMinNm * 1.852, xMaxKm = xMaxNm * 1.852;
      const gsAtMax = xMaxKm * tanG * 3281;
      const MAX_ALT = Math.ceil(Math.max(gsAtMax, Math.max(altFt, 50)) * 1.25 / 1000) * 1000 || 5000;
      const altStep = Math.ceil(MAX_ALT / 4 / 500) * 500;
      const nmStep = 5;

      function xp(km) { return PAD_L + (1 - (km - xMinKm) / (xMaxKm - xMinKm)) * gW; }
      function yp(ft)  { return PAD_T + (1 - ft / MAX_ALT) * gH; }

      ctx.strokeStyle = dimColor; ctx.lineWidth = 1; ctx.setLineDash([2, 4]);
      for (let a = altStep; a < MAX_ALT; a += altStep) {
        ctx.beginPath(); ctx.moveTo(PAD_L, yp(a)); ctx.lineTo(W - PAD_R, yp(a)); ctx.stroke();
      }
      for (let n = Math.ceil(xMinNm / nmStep) * nmStep; n <= xMaxNm; n += nmStep) {
        const km = n * 1.852;
        ctx.beginPath(); ctx.moveTo(xp(km), PAD_T); ctx.lineTo(xp(km), H - PAD_B); ctx.stroke();
      }
      ctx.setLineDash([]);

      ctx.strokeStyle = color; ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(PAD_L, PAD_T); ctx.lineTo(PAD_L, H - PAD_B);
      ctx.moveTo(PAD_L, H - PAD_B); ctx.lineTo(W - PAD_R, H - PAD_B);
      ctx.stroke();

      ctx.fillStyle = color; ctx.font = '9px Share Tech Mono, monospace'; ctx.textAlign = 'right';
      for (let a = 0; a <= MAX_ALT; a += altStep)
        ctx.fillText(a === 0 ? '0' : (a/1000).toFixed(1)+'K', PAD_L - 2, yp(a) + 3);
      ctx.textAlign = 'center';
      for (let n = Math.ceil(xMinNm / nmStep) * nmStep; n <= xMaxNm; n += nmStep)
        ctx.fillText(n + 'nm', xp(n * 1.852), H - PAD_B + 12);
      if (0 >= xMinKm && 0 <= xMaxKm) {
        ctx.fillText('SYD', xp(0), H - PAD_B + 12);
        ctx.strokeStyle = color; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(xp(0), PAD_T); ctx.lineTo(xp(0), H - PAD_B); ctx.stroke();
      }

      ctx.strokeStyle = dimColor; ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(xp(xMinKm), yp(xMinKm * tanG * 3281));
      ctx.lineTo(xp(xMaxKm), yp(xMaxKm * tanG * 3281));
      ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle = dimColor; ctx.textAlign = 'left'; ctx.font = '9px Share Tech Mono, monospace';
      ctx.fillText('3° GS', PAD_L + 4, yp(xMinKm * tanG * 3281) - 3);

      const ac_x = xp(distKm), ac_y = yp(altFt);
      const gsAltAtDist = distKm * tanG * 3281;
      const gs_y = yp(gsAltAtDist);
      const above = altFt > gsAltAtDist;
      const dotColor = above ? '#e8e820' : color;
      ctx.strokeStyle = dotColor; ctx.lineWidth = 1; ctx.setLineDash([2, 2]);
      ctx.beginPath(); ctx.moveTo(ac_x, Math.min(ac_y, gs_y)); ctx.lineTo(ac_x, Math.max(ac_y, gs_y)); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = dotColor; ctx.beginPath(); ctx.arc(ac_x, ac_y, 4, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = dotColor; ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(ac_x - 8, ac_y); ctx.lineTo(ac_x + 8, ac_y);
      ctx.moveTo(ac_x, ac_y - 8); ctx.lineTo(ac_x, ac_y + 8);
      ctx.stroke();
      const devFt = Math.round(altFt - gsAltAtDist);
      ctx.fillStyle = dotColor; ctx.textAlign = 'left'; ctx.font = 'bold 9px Share Tech Mono, monospace';
      ctx.fillText((devFt > 0 ? '+' : '') + Math.round(devFt / 100) * 100 + 'FT', ac_x + 7, ac_y - 3);
    }

    function render(f) {
      const ctr = '[' + (i+1) + '/' + flights.length + ']';
      const dist = haversineKm(SYD_LAT, SYD_LON, f.lat, f.lon);
      const altFt = typeof f.alt_baro === 'number' ? f.alt_baro : 0;
      const altStr = typeof f.alt_baro === 'number' ? f.alt_baro.toLocaleString() + ' FT' : '---';
      const spd = f.gs ? Math.round(f.gs) + ' KT' : '---';
      const vs = f.baro_rate ? (f.baro_rate > 0 ? '+' : '') + f.baro_rate + ' FPM' : '---';
      const hdg = f.track ? Math.round(f.track) + '°' : '---';
      const call = (f.flight || '---').trim().toUpperCase();
      const type = (f.t || f.category || '---').toUpperCase();
      const reg = (f.r || '---').toUpperCase();
      const sqk = f.squawk || '---';
      const airline = (f.airline || f.op || '---').toUpperCase();
      const origin = guessOrigin(call);

      document.getElementById('info').innerHTML =
        'FLIGHT&nbsp;&nbsp; ' + call + '<br>' +
        'REG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + reg + '<br>' +
        'TYPE&nbsp;&nbsp;&nbsp;&nbsp; ' + type + '<br>' +
        'AIRLINE&nbsp; ' + airline +
        (origin ? '<br>FROM&nbsp;&nbsp;&nbsp;&nbsp; ' + origin : '');

      document.getElementById('main').innerHTML =
        'ALT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + altStr + '<br>' +
        'SPEED&nbsp;&nbsp;&nbsp; ' + spd + '<br>' +
        'V/SPEED&nbsp; ' + vs + '<br>' +
        'HEADING&nbsp; ' + hdg + '<br>' +
        'DIST SYD&nbsp; ' + dist.toFixed(1) + ' KM<br>' +
        'SQUAWK&nbsp;&nbsp; ' + sqk;

      document.getElementById('counter').textContent = ctr;
      fetchPhoto(reg, f.hex || '', type);
      drawProfile('dm-canvas', dist, altFt, '#ff6600', '#1a0a00', '#7a3300');
    }

    let lastPhotoReg = null;
    async function fetchPhoto(reg, hex, type) {
      if (!reg || reg === '---') { clearPhoto(); return; }
      if (reg === lastPhotoReg) return;
      lastPhotoReg = reg;
      clearPhoto();
      try {
        const res = await fetch('https://api.planespotters.net/pub/photos/hex/' + hex + '?reg=' + reg + '&icaoType=' + type, { signal: AbortSignal.timeout(6000) });
        if (!res.ok) return;
        const data = await res.json();
        const photo = data.photos && data.photos[0];
        if (!photo) return;
        const src = photo.thumbnail_large?.src || photo.thumbnail?.src;
        if (src) {
          const dm = document.getElementById('dm-photo');
          if (dm) { dm.src = src; dm.style.display = 'block'; }
          const cr = document.getElementById('dm-photo-credit');
          if (cr) cr.textContent = photo.photographer ? '© ' + photo.photographer : '';
        }
      } catch(e) {}
    }
    function clearPhoto() {
      const el = document.getElementById('dm-photo');
      if (el) { el.src=''; el.style.display='none'; }
      const cr = document.getElementById('dm-photo-credit');
      if (cr) cr.textContent = '';
    }

    function go(n) { if (flights.length) { i = (n + flights.length) % flights.length; render(flights[i]); } }
    function next() { go(i + 1); }
    function prev() { go(i - 1); }

    let secs = 15;
    setInterval(() => {
      secs--;
      document.getElementById('refresh-timer').textContent = 'REFRESH IN ' + secs + 'S';
      if (secs <= 0) { secs = 15; fetchFlights(); }
    }, 1000);

    let retryCount = 0;
    async function fetchFlights() {
      const spinner = document.getElementById('spinner');
      const errorEl = document.getElementById('error');
      spinner.style.display = 'block';
      errorEl.textContent = '';

      try {
        const res = await fetch('https://api.airplanes.live/v2/point/' + SYD_LAT + '/' + SYD_LON + '/50', { signal: AbortSignal.timeout(10000) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        let ac = data.ac || [];

        const BANK_LAT = -33.9244, BANK_LON = 150.9883;
        function nearBankstown(f) { return haversineKm(BANK_LAT, BANK_LON, f.lat, f.lon) < 8; }

        ac = ac.filter(f => typeof f.alt_baro === 'number' && f.lat && f.lon && f.baro_rate < 0 && !nearBankstown(f));
        ac.sort((a, b) => haversineKm(SYD_LAT, SYD_LON, a.lat, a.lon) - haversineKm(SYD_LAT, SYD_LON, b.lat, b.lon));

        if (ac.length === 0) {
          ac = (data.ac || []).filter(f => typeof f.alt_baro === 'number' && f.lat && f.lon && !nearBankstown(f));
          ac.sort((a, b) => haversineKm(SYD_LAT, SYD_LON, a.lat, a.lon) - haversineKm(SYD_LAT, SYD_LON, b.lat, b.lon));
          if (!ac.length) { document.getElementById('info').textContent = 'NO TRAFFIC DETECTED.'; spinner.style.display = 'none'; return; }
        }

        flights = ac;
        i = 0;
        retryCount = 0;
        spinner.style.display = 'none';
        render(flights[0]);

      } catch(e) {
        spinner.style.display = 'none';
        retryCount++;
        if (retryCount <= 3) {
          const wait = retryCount * 5;
          errorEl.textContent = 'ERR: ' + e.message + ' — retrying in ' + wait + 's (' + retryCount + '/3)';
          setTimeout(fetchFlights, wait * 1000);
        } else {
          errorEl.textContent = 'ERR: ' + e.message + ' — refresh page to retry.';
          retryCount = 0;
        }
      }
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
    });

    fetchFlights();
  </script>
</body>
</html>
