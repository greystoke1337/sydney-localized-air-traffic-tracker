<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Overhead Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* ─── DOTMATRIX THEME ─── */
    body.dotmatrix {
      --c-main: #ffa600;
      --c-glow: #ff8000;
      --c-dim:  #7a5200;
      --c-bg:   #1a0a00;
      --c-overlay: rgba(26,10,0,0.65);
      background: var(--c-bg);
      color: var(--c-main);
      font-family: 'Share Tech Mono', monospace;
      font-size: 1rem;
      padding: 30px;
      max-width: 520px;
      margin: 0 auto;
    }
    body.dotmatrix * { text-shadow: 0 0 2px var(--c-main), 0 0 8px var(--c-glow); }
    body.dotmatrix::after {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 3px, rgba(0,0,0,0.18) 3px, rgba(0,0,0,0.18) 4px);
      pointer-events: none; z-index: 99;
    }
    body.dotmatrix hr { border-color: var(--c-main); opacity: 0.3; margin: 12px 0; }
    body.dotmatrix #info { font-size: 1.3rem; margin: 16px 0 8px; }
    body.dotmatrix #main { line-height: 1.8; margin-bottom: 16px; font-size: 0.78rem; opacity: 0.85; }
    body.dotmatrix #counter { margin: 0 12px; }
    body.dotmatrix #error { color: var(--c-glow); word-break: break-all; font-size: 0.85rem; }
    body.dotmatrix button {
      background: none; border: 1px solid var(--c-main); color: var(--c-main);
      font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
      padding: 5px 0; cursor: pointer; text-shadow: 0 0 6px var(--c-glow);
      width: 80px; text-align: center; display: inline-block;
    }
    body.dotmatrix button:hover { background: color-mix(in srgb, var(--c-main) 13%, transparent); }
    #location-ctrl { display: flex; gap: 6px; align-items: center; margin: 10px 0 4px; }
    #suburb-input {
      background: none; border: 1px solid var(--c-main); color: var(--c-main);
      font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;
      padding: 4px 8px; flex: 1; outline: none;
      text-shadow: 0 0 6px var(--c-glow);
    }
    #suburb-input::placeholder { color: var(--c-dim); text-shadow: none; }
    #geofence-ctrl { font-size: 0.75rem; opacity: 0.8; margin: 0 0 8px; display:flex; align-items:center; gap:8px; }
    #geofence-slider { flex:1; accent-color:var(--c-main); cursor:pointer; }
    /* Photo */
    .photo-wrap { position:relative; display:block; margin-top:10px; z-index: 0; border:1px solid var(--c-dim); }
    .photo-wrap::after {
      content:''; position:absolute; inset:0; pointer-events:none; z-index: 1;
      background-image: radial-gradient(circle, rgba(0,0,0,0.25) 1px, transparent 1px);
      background-size: 3px 3px;
    }
    #dm-photo { display:block; width:100%; max-height:120px; object-fit:cover; object-position:center; opacity:0.85; }
    #dm-photo-credit { font-size:0.6rem; opacity:0.5; margin-top:2px; }

    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:0} }

    /* Map */
    #dm-map { width:100%; height:220px; margin-top:14px; border:1px solid var(--c-dim); }
    #dm-map * { text-shadow: none; }
    .dm-callout { background: var(--c-bg); border:1px solid var(--c-main); color: var(--c-main);
      font-family:'Share Tech Mono',monospace; font-size:11px; padding:2px 5px;
      border-radius:0; white-space:nowrap; }
    .dm-callout::before { display:none; }
    .leaflet-control-attribution { font-size:9px; opacity:0.35; background:transparent !important; color:#aaa !important; }
    .leaflet-control-attribution a { color:#aaa !important; }
  </style>
</head>
<body class="dotmatrix">

  <!-- ══ DOTMATRIX LAYOUT ══ -->
  <div class="classic-layout">
    <p>OVERHEAD // <span id="suburb-display">RUSSELL LEA</span><br>LIVE AIRCRAFT TRACKER <span class="blink">█</span></p>
    <hr>
    <div id="location-ctrl">
      <input id="suburb-input" value="Russell Lea" placeholder="Enter suburb...">
      <button onclick="setLocation()">SET LOCATION</button>
    </div>
    <div id="geofence-ctrl">
      <span>GEOFENCE</span>
      <input type="range" id="geofence-slider" min="2" max="20" value="5" step="1">
      <span id="geofence-label">5 KM</span>
    </div>
    <p id="error"></p>
    <p id="info">LOADING...</p>
    <p id="main"></p>
    <div id="dm-map"></div>
    <div class="photo-wrap" id="photo-wrap" style="display:none"><img id="dm-photo" alt="Aircraft photo"></div>
    <p id="dm-photo-credit"></p>
    <hr>
    <button onclick="prev()">&#9664; PREV</button>
    <span id="counter"></span>
    <button onclick="next()">NEXT &#9654;</button>
    <button onclick="go(0)">NEAREST</button>
    <button onclick="manualRefresh()">REFRESH</button>
    <br><br>
    <span id="refresh-timer"></span>
  </div>
  <script>
    const SYD_LAT = -33.9461, SYD_LON = 151.1772;
    let geofenceKm = 5;
    function apiRadiusNm() { return Math.ceil((geofenceKm / 1.852) * 4); }

    let suburbName = 'RUSSELL LEA';
    let suburbLat = -33.8598, suburbLon = 151.1369;
    let flights = [], flightIndex = 0;
    let fetchController = null;

    // ── Theme (orange only)
    const THEMES = {
      orange: { main: '#ffa600', glow: '#ff8000', dim: '#7a5200', bg: '#1a0a00', overlay: 'rgba(26,10,0,0.65)', acMarker: '#e8e820' },
    };
    let currentTheme = 'orange';

    function applyTheme(name) {
      const t = THEMES[name];
      const b = document.body;
      b.style.setProperty('--c-main',    t.main);
      b.style.setProperty('--c-glow',    t.glow);
      b.style.setProperty('--c-dim',     t.dim);
      b.style.setProperty('--c-bg',      t.bg);
      b.style.setProperty('--c-overlay', t.overlay);
      if (geofenceCircle) geofenceCircle.setStyle({ color: t.main, fillColor: t.main });
      if (acLine)         acLine.setStyle({ color: t.main });
      if (acVector)       acVector.setStyle({ color: t.acMarker });
      if (acArrowHead)    acArrowHead.setStyle({ color: t.acMarker });
      currentTheme = name;
    }

    // ── Restore last suburb from localStorage
    (function () {
      try {
        const saved = localStorage.getItem('suburb');
        if (saved) {
          const { name, lat, lon } = JSON.parse(saved);
          suburbName = name.toUpperCase();
          suburbLat = lat;
          suburbLon = lon;
          document.getElementById('suburb-input').value = name;
          document.getElementById('suburb-display').textContent = suburbName;
        }
      } catch (e) {}
    })();

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ── ICAO airline designator → name (for airlines serving SYD)
    const AIRLINE_DB = {
      QFA:'QANTAS',         VOZ:'VIRGIN AUSTRALIA', JST:'JETSTAR',
      RXA:'REX',            NWL:'NETWORK AVIATION',
      UAE:'EMIRATES',       ETD:'ETIHAD',            QTR:'QATAR AIRWAYS',
      SIA:'SINGAPORE AIR',  MAS:'MALAYSIA AIRLINES', CPA:'CATHAY PACIFIC',
      ANZ:'AIR NEW ZEALAND',FJI:'FIJI AIRWAYS',      THA:'THAI AIRWAYS',
      THY:'TURKISH AIRLINES',GIA:'GARUDA',           PAL:'PHILIPPINE AIR',
      AIQ:'THAI AIRASIA X', XAX:'AIRASIA X',         VNA:'VIETNAM AIRLINES',
      EVA:'EVA AIR',        CCA:'AIR CHINA',         CSN:'CHINA SOUTHERN',
      CES:'CHINA EASTERN',  KAL:'KOREAN AIR',        AAR:'ASIANA',
      ANA:'ANA',            JAL:'JAPAN AIRLINES',    AAL:'AMERICAN AIRLINES',
      UAL:'UNITED AIRLINES',DAL:'DELTA AIR LINES',   ACA:'AIR CANADA',
      BAW:'BRITISH AIRWAYS',AFR:'AIR FRANCE',        DLH:'LUFTHANSA',
      HAL:'HAWAIIAN AIRLINES',
    };
    function airlineFromCallsign(callsign) {
      if (!callsign || callsign === '---') return '---';
      const prefix = callsign.match(/^[A-Z]+/)?.[0] || '';
      return AIRLINE_DB[prefix] || prefix || '---';
    }

    // ── ADS-B emitter category → human label
    const CATEGORY_DB = {
      A1:'LIGHT', A2:'SMALL', A3:'LARGE', A4:'B757 CLASS', A5:'HEAVY',
      A6:'HIGH PERF', A7:'ROTORCRAFT', B1:'GLIDER', B2:'AIRSHIP',
      B4:'SKYDIVER', B6:'UAV', B7:'SPACECRAFT', C1:'GROUND VEH',
    };
    // ── ICAO aircraft type code → full name
    const AIRCRAFT_TYPE_DB = {
      // Boeing narrowbody
      B737:'B737-700', B738:'B737-800', B739:'B737-900', B73X:'B737-900ER',
      B37M:'B737 MAX 7', B38M:'B737 MAX 8', B39M:'B737 MAX 9', B3XM:'B737 MAX 10',
      B752:'B757-200', B753:'B757-300',
      // Boeing widebody
      B762:'B767-200', B763:'B767-300', B764:'B767-400',
      B772:'B777-200', B77L:'B777-200LR', B773:'B777-300', B77W:'B777-300ER',
      B778:'B777X-8', B779:'B777X-9',
      B788:'B787-8', B789:'B787-9', B78X:'B787-10',
      // Boeing classic / other
      B712:'B717-200', B721:'B727-100', B722:'B727-200',
      B741:'B747-100', B742:'B747-200', B743:'B747-300', B744:'B747-400', B748:'B747-8',
      // Airbus narrowbody
      A318:'A318', A319:'A319', A320:'A320', A321:'A321',
      A19N:'A319neo', A20N:'A320neo', A21N:'A321neo', A21X:'A321XLR',
      // Airbus widebody
      A332:'A330-200', A333:'A330-300', A338:'A330-800neo', A339:'A330-900neo',
      A342:'A340-200', A343:'A340-300', A345:'A340-500', A346:'A340-600',
      A359:'A350-900', A35K:'A350-1000',
      A380:'A380', A388:'A380-800',
      // Embraer
      E170:'E170', E175:'E175', E190:'E190', E195:'E195',
      E75L:'E175-E2', E290:'E190-E2', E295:'E195-E2',
      // Bombardier / CRJ
      CRJ2:'CRJ-200', CRJ7:'CRJ-700', CRJ9:'CRJ-900', CRJX:'CRJ-1000',
      DH8A:'DASH 8-100', DH8B:'DASH 8-200', DH8C:'DASH 8-300', DH8D:'DASH 8-400',
      // ATR
      AT43:'ATR 42-300', AT45:'ATR 42-500', AT72:'ATR 72-200', AT75:'ATR 72-500', AT76:'ATR 72-600',
      // Airbus A220 (formerly Bombardier CSeries)
      BCS1:'A220-100', BCS3:'A220-300',
      // Regional / turboprop
      SF34:'SAAB 340', SB20:'SAAB 2000', JS41:'JETSTREAM 41',
      PC12:'PILATUS PC-12', C208:'CESSNA CARAVAN',
      // Business jets
      GL5T:'GULFSTREAM G550', GLEX:'GLOBAL EXPRESS', GLF6:'GULFSTREAM G650',
      C25A:'CITATION CJ2', C25B:'CITATION CJ3', C68A:'CITATION SOVEREIGN',
      FA7X:'FALCON 7X', FA8X:'FALCON 8X',
      // Military / special
      C130:'C-130 HERCULES', C17:'C-17 GLOBEMASTER', P8:'P-8 POSEIDON',
      E3CF:'E-3 SENTRY', B52:'B-52 STRATOFORTRESS',
      // Helicopter
      EC35:'H135', EC45:'H145', S76:'SIKORSKY S-76', AS32:'SUPER PUMA',
      B06:'BELL 206', B407:'BELL 407',
    };
    function formatType(t, category) {
      const typeCode = (t || '').toUpperCase();
      const cat = (category || '').toUpperCase();
      const fullName = AIRCRAFT_TYPE_DB[typeCode];
      const catLabel = CATEGORY_DB[cat];
      if (fullName && catLabel) return fullName + ' (' + catLabel + ')';
      if (fullName) return fullName;
      if (typeCode && catLabel) return typeCode + ' (' + catLabel + ')';
      if (typeCode) return typeCode;
      if (catLabel) return catLabel;
      return cat || '---';
    }

    // ── Emergency squawk formatting
    const EMERG_SQUAWKS = { '7700':'MAYDAY', '7600':'NORDO', '7500':'HIJACK' };
    function formatSquawk(sqk) {
      if (!sqk || sqk === '---') return '---';
      const emerg = EMERG_SQUAWKS[sqk];
      if (emerg) return '<span style="color:#ff2020;text-shadow:0 0 8px #ff0000;">' + sqk + ' \u26a0 ' + emerg + '</span>';
      return sqk;
    }

    // ── Altitude: FL above transition altitude, QNH below
    function formatAlt(alt) {
      if (typeof alt !== 'number') return '---';
      if (alt >= 10000) return 'FL' + String(Math.round(alt / 100)).padStart(3, '0');
      return alt.toLocaleString() + ' FT QNH';
    }

    // ── Map
    let map, acMarker, acLine, acVector, acArrowHead, geofenceCircle, suburbMarker;
    function initMap() {
      map = L.map('dm-map', { zoomControl: false })
        .setView([suburbLat, suburbLon], 11);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap © Carto', maxZoom: 14
      }).addTo(map);
      L.circleMarker([SYD_LAT, SYD_LON], {
        radius: 4, color: THEMES[currentTheme].dim, fillColor: THEMES[currentTheme].dim, fillOpacity: 1, weight: 2
      }).addTo(map)
        .bindTooltip('SYD', { permanent: true, direction: 'right', className: 'dm-callout' });
      updateGeofenceCircle();
    }
    function updateGeofenceCircle() {
      const t = THEMES[currentTheme];
      if (geofenceCircle) {
        geofenceCircle.setLatLng([suburbLat, suburbLon]);
        geofenceCircle.setRadius(geofenceKm * 1000);
      } else {
        geofenceCircle = L.circle([suburbLat, suburbLon], {
          radius: geofenceKm * 1000,
          color: t.main, fillColor: t.main, fillOpacity: 0.05,
          weight: 1, dashArray: '5 5'
        }).addTo(map);
      }
      if (suburbMarker) {
        suburbMarker.setLatLng([suburbLat, suburbLon]);
        suburbMarker.getTooltip().setContent(suburbName);
      } else {
        suburbMarker = L.circleMarker([suburbLat, suburbLon], {
          radius: 5, color: '#ffffff', fillColor: '#ffffff', fillOpacity: 0.9, weight: 2
        }).addTo(map)
          .bindTooltip(suburbName, { permanent: true, direction: 'right', className: 'dm-callout' });
      }
      map.setView([suburbLat, suburbLon], 11);
    }
    function clearAircraftMarker() {
      if (acMarker)    { acMarker.remove();    acMarker = null; }
      if (acLine)      { acLine.remove();      acLine = null; }
      if (acVector)    { acVector.remove();    acVector = null; }
      if (acArrowHead) { acArrowHead.remove(); acArrowHead = null; }
    }
    // Returns a lat/lon point distKm away from [lat,lon] in bearingDeg direction
    function destPoint(lat, lon, bearingDeg, distKm) {
      const R = 6371, d = distKm / R, brng = bearingDeg * Math.PI / 180;
      const lat1 = lat * Math.PI / 180, lon1 = lon * Math.PI / 180;
      const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d) + Math.cos(lat1)*Math.sin(d)*Math.cos(brng));
      const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
      return [lat2 * 180/Math.PI, lon2 * 180/Math.PI];
    }
    function updateMap(lat, lon, callsign, groundSpeedKt, trackDeg) {
      const pos = [lat, lon];
      const t = THEMES[currentTheme];
      // Aircraft dot
      if (acMarker) {
        acMarker.setLatLng(pos);
        acMarker.getTooltip().setContent(callsign);
      } else {
        acMarker = L.circleMarker(pos, {
          radius: 7, color: t.acMarker, fillColor: t.acMarker, fillOpacity: 1, weight: 2
        }).addTo(map)
          .bindTooltip(callsign, { permanent: true, direction: 'top', className: 'dm-callout' });
      }
      // Dashed line to suburb
      if (acLine) acLine.setLatLngs([pos, [suburbLat, suburbLon]]);
      else acLine = L.polyline([pos, [suburbLat, suburbLon]], {
        color: t.main, weight: 1, opacity: 0.4, dashArray: '4 6'
      }).addTo(map);
      // Speed-scaled heading vector + chevron arrowhead
      if (typeof groundSpeedKt === 'number' && groundSpeedKt > 0 && typeof trackDeg === 'number') {
        const vectorKm = Math.max(0.5, Math.min(groundSpeedKt / 100, 8));
        const tip = destPoint(lat, lon, trackDeg, vectorKm);
        const headKm = vectorKm * 0.28;
        const leftWing  = destPoint(tip[0], tip[1], (trackDeg + 180 - 28 + 360) % 360, headKm);
        const rightWing = destPoint(tip[0], tip[1], (trackDeg + 180 + 28) % 360, headKm);
        const vs = { color: t.acMarker, weight: 2, opacity: 0.9 };
        if (acVector) {
          acVector.setLatLngs([pos, tip]);
          acArrowHead.setLatLngs([leftWing, tip, rightWing]);
        } else {
          acVector    = L.polyline([pos, tip], vs).addTo(map);
          acArrowHead = L.polyline([leftWing, tip, rightWing], vs).addTo(map);
        }
      } else {
        if (acVector)    { acVector.remove();    acVector = null; }
        if (acArrowHead) { acArrowHead.remove(); acArrowHead = null; }
      }
      const distSuburbSyd = haversineKm(suburbLat, suburbLon, SYD_LAT, SYD_LON);
      const boundsPoints = distSuburbSyd < 40
        ? [pos, [suburbLat, suburbLon], [SYD_LAT, SYD_LON]]
        : [pos, [suburbLat, suburbLon]];
      map.fitBounds(L.latLngBounds(boundsPoints).pad(0.3));
    }

    function render(f) {
      const ctr = '[' + (flightIndex+1) + '/' + flights.length + ']';
      const distLoc = haversineKm(suburbLat, suburbLon, f.lat, f.lon);
      const distSyd = haversineKm(SYD_LAT, SYD_LON, f.lat, f.lon);
      const altStr = formatAlt(f.alt_baro);
      const spd = f.gs ? Math.round(f.gs) + ' KT' : '---';
      const vs = f.baro_rate ? (f.baro_rate > 0 ? '+' : '') + f.baro_rate + ' FPM' : '---';
      const hdg = f.track ? Math.round(f.track) + '°' : '---';
      const call = (f.flight || '---').trim().toUpperCase();
      const typeStr = formatType(f.t, f.category);
      const reg = (f.r || '---').toUpperCase();
      const sqkStr = formatSquawk(f.squawk || '---');

      const airline = airlineFromCallsign(call);
      const callLink = call !== '---'
        ? '<a href="https://www.flightaware.com/live/flight/' + call + '" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">' + call + '</a>'
        : '---';

      document.getElementById('info').innerHTML =
        'FLIGHT&nbsp;&nbsp; ' + callLink + '<br>' +
        'REG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + reg + '<br>' +
        'TYPE&nbsp;&nbsp;&nbsp;&nbsp; ' + typeStr + '<br>' +
        'AIRLINE&nbsp; ' + airline;
      document.getElementById('main').innerHTML =
        'ALT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + altStr + '<br>' +
        'SPEED&nbsp;&nbsp;&nbsp; ' + spd + '<br>' +
        'V/SPEED&nbsp; ' + vs + '<br>' +
        'GND TRK&nbsp; ' + hdg + '<br>' +
        'DIST LOC&nbsp; ' + distLoc.toFixed(1) + ' KM<br>' +
        'DIST SYD&nbsp; ' + distSyd.toFixed(1) + ' KM<br>' +
        'SQUAWK&nbsp;&nbsp; ' + sqkStr;
      document.getElementById('counter').textContent = ctr;

      fetchPhoto(reg, f.hex || '', (f.t || '').toUpperCase());
      updateMap(f.lat, f.lon, call, f.gs, f.track);
    }

    // ── Fetch aircraft photo from Planespotters
    let lastPhotoReg = null;
    async function fetchPhoto(reg, hex, type) {
      if (!reg || reg === '---') { clearPhoto(); return; }
      if (reg === lastPhotoReg) return;
      lastPhotoReg = reg;
      clearPhoto();
      try {
        const url = 'https://api.planespotters.net/pub/photos/hex/' + hex + '?reg=' + reg + '&icaoType=' + type;
        const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
        if (!res.ok) return;
        const data = await res.json();
        const photo = data.photos && data.photos[0];
        if (!photo) return;
        const src = photo.thumbnail_large?.src || photo.thumbnail?.src;
        const credit = photo.photographer ? '© ' + photo.photographer : '';
        if (src) setPhoto(src, credit);
      } catch(e) {}
    }
    function setPhoto(src, credit) {
      const dm = document.getElementById('dm-photo');
      const wrap = document.getElementById('photo-wrap');
      if (dm) dm.src = src;
      if (wrap) wrap.style.display = 'block';
      const cr = document.getElementById('dm-photo-credit');
      if (cr) cr.textContent = credit;
    }
    function clearPhoto() {
      const dm = document.getElementById('dm-photo');
      const wrap = document.getElementById('photo-wrap');
      if (dm) dm.src = '';
      if (wrap) wrap.style.display = 'none';
    }

    function go(n) { if (flights.length) { flightIndex = (n + flights.length) % flights.length; render(flights[flightIndex]); } }
    function next() { go(flightIndex + 1); }
    function prev() { go(flightIndex - 1); }
    function manualRefresh() { secs = 30; fetchFlights(); }

    let secs = 30;
    setInterval(() => {
      secs--;
      document.getElementById('refresh-timer').textContent = 'REFRESH IN ' + secs + 'S';
      if (secs <= 0) fetchFlights();
    }, 1000);

    // ── Geocode suburb name → lat/lon via Nominatim (OSM)
    async function geocodeSuburb(name) {
      const q = encodeURIComponent(name + ', Australia');
      const url = 'https://nominatim.openstreetmap.org/search?q=' + q + '&format=json&limit=1';
      const res = await fetch(url, {
        signal: AbortSignal.timeout(8000),
        headers: { 'Accept-Language': 'en' }
      });
      if (!res.ok) throw new Error('Geocoding request failed');
      const data = await res.json();
      if (!data.length) throw new Error('Suburb not found: ' + name);
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function setLocation() {
      const input = document.getElementById('suburb-input').value.trim();
      if (!input) return;
      document.getElementById('error').textContent = 'LOCATING ' + input.toUpperCase() + '...';
      try {
        const { lat, lon } = await geocodeSuburb(input);
        suburbName = input.toUpperCase();
        suburbLat = lat;
        suburbLon = lon;
        document.getElementById('suburb-display').textContent = suburbName;
        document.getElementById('error').textContent = '';
        lastPhotoReg = null;
        clearAircraftMarker();
        updateGeofenceCircle();
        try { localStorage.setItem('suburb', JSON.stringify({ name: input, lat, lon })); } catch(e) {}
        await fetchFlights();
      } catch(e) {
        document.getElementById('error').textContent = 'LOCATION ERR: ' + e.message;
      }
    }

    async function fetchFlights() {
      if (fetchController) fetchController.abort();
      fetchController = new AbortController();
      const signal = fetchController.signal;

      document.getElementById('info').textContent = 'FETCHING DATA...';
      document.getElementById('error').textContent = '';
      try {
        const url = 'https://api.airplanes.live/v2/point/' + suburbLat + '/' + suburbLon + '/' + apiRadiusNm();
        const res = await fetch(url, { signal });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        let ac = (data.ac || []).filter(f =>
          typeof f.alt_baro === 'number' && f.alt_baro >= 500 && f.lat && f.lon &&
          haversineKm(suburbLat, suburbLon, f.lat, f.lon) <= geofenceKm
        );
        ac.sort((a, b) =>
          haversineKm(suburbLat, suburbLon, a.lat, a.lon) -
          haversineKm(suburbLat, suburbLon, b.lat, b.lon)
        );
        if (!ac.length) {
          clearAircraftMarker();
          clearPhoto();
          document.getElementById('info').textContent = 'NO AIRCRAFT ABOVE ' + suburbName + '.';
          document.getElementById('main').textContent = '';
          document.getElementById('counter').textContent = '';
          return;
        }
        flights = ac;
        flightIndex = 0;
        render(flights[0]);
      } catch(e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        document.getElementById('error').textContent = 'ERR: ' + e.message;
        document.getElementById('info').textContent = '^ SEE ABOVE';
      } finally {
        secs = 30;
      }
    }

    document.addEventListener('keydown', e => {
      if (document.activeElement === document.getElementById('suburb-input')) return;
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
    });
    document.getElementById('suburb-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') setLocation();
    });

    // ── Geofence slider
    (function () {
      try {
        const saved = parseInt(localStorage.getItem('geofenceKm'), 10);
        if (saved >= 2 && saved <= 20) {
          geofenceKm = saved;
          document.getElementById('geofence-slider').value = saved;
          document.getElementById('geofence-label').textContent = saved + ' KM';
        }
      } catch(e) {}
    })();
    document.getElementById('geofence-slider').addEventListener('input', function () {
      geofenceKm = parseInt(this.value, 10);
      document.getElementById('geofence-label').textContent = geofenceKm + ' KM';
      if (geofenceCircle) updateGeofenceCircle();
      try { localStorage.setItem('geofenceKm', geofenceKm); } catch(e) {}
      fetchFlights();
    });

    initMap();
    fetchFlights();
  </script>
</body>
</html>
