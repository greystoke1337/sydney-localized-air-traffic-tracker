<!DOCTYPE html>
<!--
  OVERHEAD // LIVE AIRCRAFT TRACKER
  Single-file app â€” no server, no build step, no API keys.

  Flow: user types a location â†’ geocode via OSM â†’ query airplanes.live
        â†’ filter to geofence â†’ display flight data, map, photo â†’ repeat every 15s

  Libraries: Leaflet.js (map), Google Fonts
  APIs: airplanes.live (ADS-B), Nominatim/OSM (geocoding),
        Planespotters.net (photos), CartoDB (map tiles)
-->
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Overhead Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Include padding/border in element size calculations */
    *, *::before, *::after { box-sizing: border-box; }

    body.dotmatrix {
      /* Orange-on-black CRT colour palette */
      --c-main: #ffa600;
      --c-glow: #ff8000;
      --c-dim:  #7a5200;
      --c-bg:   #1a0a00;
      --c-overlay: rgba(26,10,0,0.65);
      --scanline-opacity: 0.05;

      background: var(--c-bg);
      color: var(--c-main);
      font-family: 'Share Tech Mono', monospace;
      font-size: clamp(0.85rem, 2.5vw, 1rem); /* fluid: scales between min/max */
      padding: 16px;
      max-width: 520px;
      margin: 0 auto;
      min-height: 100dvh; /* dvh accounts for mobile browser chrome */
    }

    /* Soft orange glow on all text */
    body.dotmatrix * { text-shadow: 0 0 2px var(--c-main), 0 0 8px var(--c-glow); }

    /* CRT scanline overlay â€” fixed pseudo-element, passes clicks through */
    body.dotmatrix::after {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(
        to bottom,
        transparent 0px, transparent 3px,
        rgba(0,0,0,var(--scanline-opacity)) 3px, rgba(0,0,0,var(--scanline-opacity)) 4px
      );
      pointer-events: none; z-index: 99;
    }

    body.dotmatrix hr { border-color: var(--c-main); opacity: 0.3; margin: 10px 0; }
    body.dotmatrix #counter { margin: 0 6px; }
    body.dotmatrix #error { color: var(--c-glow); word-break: break-all; font-size: 0.85rem; }

    /* Flight info block â€” left border changes colour with flight phase */
    #info-wrap {
      position: relative; /* needed so the altitude bar can sit inside */
      margin: 12px 0 6px;
      padding-left: 10px;
      border-left: 3px solid var(--c-main);
      transition: border-color 0.5s, box-shadow 0.5s;
    }
    #info-wrap.phase-landing    { border-color: #ff6060; box-shadow: -4px 0 12px rgba(255,96,96,0.3); }
    #info-wrap.phase-takeoff    { border-color: #60ff90; box-shadow: -4px 0 12px rgba(96,255,144,0.3); }
    #info-wrap.phase-climbing   { border-color: #60ff90; box-shadow: -4px 0 12px rgba(96,255,144,0.2); }
    #info-wrap.phase-descending { border-color: #ff9040; box-shadow: -4px 0 12px rgba(255,144,64,0.25); }
    #info-wrap.phase-approach   { border-color: #ffcc40; box-shadow: -4px 0 12px rgba(255,204,64,0.25); }

    /* Altitude bar â€” thin vertical strip on the right, fills bottom-to-top */
    #alt-bar-wrap {
      position: absolute; right: 0; top: 0; bottom: 0;
      width: 6px; background: rgba(255,166,0,0.1); border: 1px solid var(--c-dim);
    }
    #alt-bar-fill {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: var(--c-main);
      transition: height 0.6s ease;
      box-shadow: 0 0 6px var(--c-glow);
    }

    #info { font-size: clamp(1rem, 4vw, 1.3rem); line-height: 1.7; padding-right: 14px; }
    #main { line-height: 1.8; margin-bottom: 12px; font-size: clamp(0.72rem, 2vw, 0.78rem); opacity: 0.85; }

    /* Buttons â€” equal-width flex row that wraps on narrow screens */
    #btn-row { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
    body.dotmatrix button {
      background: none; border: 1px solid var(--c-main); color: var(--c-main);
      font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
      padding: 10px 0; cursor: pointer; text-shadow: 0 0 6px var(--c-glow);
      flex: 1 1 60px; text-align: center;
      min-height: 44px; /* minimum touch target */
      -webkit-tap-highlight-color: transparent;
    }
    body.dotmatrix button:hover, body.dotmatrix button:active {
      background: color-mix(in srgb, var(--c-main) 13%, transparent);
    }
    body.dotmatrix button.active {
      background: color-mix(in srgb, var(--c-main) 20%, transparent);
      border-color: var(--c-glow);
    }

    /* Location input row */
    #location-ctrl { display: flex; gap: 6px; align-items: stretch; margin: 10px 0 6px; }
    #location-input {
      background: none; border: 1px solid var(--c-main); color: var(--c-main);
      font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;
      padding: 10px 8px; flex: 1; outline: none;
      text-shadow: 0 0 6px var(--c-glow);
      min-height: 44px; -webkit-appearance: none;
    }
    #location-input::placeholder { color: var(--c-dim); text-shadow: none; }
    #location-ctrl button { flex: 0 0 auto; width: auto; padding: 10px 12px; }

    /* Sliders */
    .slider-ctrl { font-size: 0.75rem; opacity: 0.8; margin: 0 0 6px; display: flex; align-items: center; gap: 8px; }
    .slider-ctrl input[type=range] { flex: 1; accent-color: var(--c-main); cursor: pointer; height: 20px; }
    .slider-ctrl span:last-child { min-width: 52px; text-align: right; }

    /* Aircraft photo â€” hero-style, halftone dot overlay for texture */
    .photo-wrap { position: relative; display: block; margin-top: 10px; z-index: 0; border: 1px solid var(--c-dim); overflow: hidden; }
    .photo-wrap::after {
      content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 1;
      background-image: radial-gradient(circle, rgba(0,0,0,0.25) 1px, transparent 1px);
      background-size: 3px 3px;
    }
    #dm-photo { display: block; width: 100%; height: clamp(140px, 35vw, 200px); object-fit: cover; object-position: center 30%; opacity: 0.9; }
    #dm-photo-credit { font-size: 0.6rem; opacity: 0.5; margin-top: 2px; }

    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* Map */
    #dm-map { width: 100%; height: clamp(180px, 40vw, 240px); margin-top: 12px; border: 1px solid var(--c-dim); }
    #dm-map * { text-shadow: none; }
    .dm-callout {
      background: var(--c-bg); border: 1px solid var(--c-main); color: var(--c-main);
      font-family: 'Share Tech Mono', monospace; font-size: 11px; padding: 2px 5px;
      border-radius: 0; white-space: nowrap;
    }
    .dm-callout::before { display: none; }
    .leaflet-control-attribution { font-size: 9px; opacity: 0.35; background: transparent !important; color: #aaa !important; }
    .leaflet-control-attribution a { color: #aaa !important; }

    /* Footer: counter left, timer right */
    #footer-row { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; opacity: 0.7; }

    /* Session log â€” native <details> collapsible */
    #log-section { margin-top: 10px; }
    #log-section summary { cursor: pointer; font-size: 0.78rem; opacity: 0.7; padding: 4px 0; list-style: none; user-select: none; -webkit-user-select: none; }
    #log-section summary::-webkit-details-marker { display: none; }
    #log-list { margin-top: 6px; max-height: 180px; overflow-y: auto; border: 1px solid var(--c-dim); padding: 6px 8px; font-size: 0.68rem; line-height: 1.9; opacity: 0.8; }
    #log-list::-webkit-scrollbar { width: 4px; }
    #log-list::-webkit-scrollbar-thumb { background: var(--c-dim); }
    .log-entry { border-bottom: 1px solid rgba(255,166,0,0.1); padding: 1px 0; }
    .log-entry:last-child { border-bottom: none; }
  </style>
</head>
<body class="dotmatrix">
  <div class="classic-layout">

    <!-- Title: location-display updated by JS on each location change -->
    <p>OVERHEAD // <span id="location-display">---</span><br>LIVE AIRCRAFT TRACKER âœˆ <span class="blink">â–ˆ</span></p>
    <hr>

    <!-- Location input: any city, suburb, or address worldwide -->
    <div id="location-ctrl">
      <input id="location-input" value="" placeholder="City, suburb, address...">
      <button onclick="setLocation()">SET LOC</button>
    </div>

    <!-- GEOFENCE: search radius. Label updates live; API refreshes on next 15s cycle. -->
    <div class="slider-ctrl">
      <span>GEOFENCE</span>
      <input type="range" id="geofence-slider" min="2" max="20" value="5" step="1">
      <span id="geofence-label">5 KM</span>
    </div>

    <!-- ALT FLOOR: hide aircraft below this altitude -->
    <div class="slider-ctrl">
      <span>ALT FLOOR</span>
      <input type="range" id="altfloor-slider" min="200" max="5000" value="500" step="100">
      <span id="altfloor-label">500 FT</span>
    </div>

    <p id="error"></p>

    <!-- Flight info: left border + altitude bar + primary/secondary data -->
    <div id="info-wrap">
      <div id="alt-bar-wrap"><div id="alt-bar-fill" style="height:0%"></div></div>
      <div id="info">LOADING...</div>
    </div>
    <p id="main"></p>

    <div id="dm-map"></div>

    <!-- Aircraft photo â€” hidden until a photo is found -->
    <div class="photo-wrap" id="photo-wrap" style="display:none">
      <img id="dm-photo" alt="Aircraft photo">
    </div>
    <p id="dm-photo-credit"></p>

    <hr>

    <!-- PREV/NEXT: browse flights | NEAREST: jump to closest | SND: ping toggle | SHARE: copy URL -->
    <div id="btn-row">
      <button onclick="prev()">&#9664; PREV</button>
      <button onclick="next()">NEXT &#9654;</button>
      <button onclick="go(0)">NEAREST</button>
      <button onclick="manualRefresh()">REFRESH</button>
      <button onclick="toggleSound()" id="sound-btn">ðŸ”‡ SND</button>
      <button onclick="shareUrl()">&#x2197; SHARE</button>
    </div>

    <div id="footer-row">
      <span id="counter"></span>
      <span id="refresh-timer"></span>
    </div>

    <!-- Session log: collapsible, populated by JS, newest entries first -->
    <details id="log-section">
      <summary>â–¶ SESSION LOG (<span id="log-count">0</span> FLIGHTS)</summary>
      <div id="log-list"><span style="opacity:0.4">No flights recorded yet.</span></div>
    </details>

  </div>

  <script>
    // â”€â”€ Constants & state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let geofenceKm = 5;   // search radius, set by slider
    let altFloorFt = 500; // minimum altitude filter, set by slider

    // Converts geofence km â†’ nautical miles for the API, with 4Ã— buffer.
    // We then filter precisely with haversineKm on the results.
    function apiRadiusNm() { return Math.ceil((geofenceKm / 1.852) * 4); }

    let locationName = '';
    let locationLat  = 0, locationLon = 0;

    let flights = [], flightIndex = 0;
    let fetchController = null; // AbortController â€” cancels stale requests


    // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Colours live here so they can be applied to both CSS vars and Leaflet layers.

    const THEMES = {
      orange: { main: '#ffa600', glow: '#ff8000', dim: '#7a5200', bg: '#1a0a00', overlay: 'rgba(26,10,0,0.65)', acMarker: '#e8e820' },
    };
    let currentTheme = 'orange';

    function applyTheme(name) {
      const t = THEMES[name];
      const b = document.body;
      b.style.setProperty('--c-main', t.main);
      b.style.setProperty('--c-glow', t.glow);
      b.style.setProperty('--c-dim',  t.dim);
      b.style.setProperty('--c-bg',   t.bg);
      b.style.setProperty('--c-overlay', t.overlay);
      if (geofenceCircle) geofenceCircle.setStyle({ color: t.main, fillColor: t.main });
      if (acLine)         acLine.setStyle({ color: t.main });
      currentTheme = name;
    }


    // â”€â”€ Startup: URL param + localStorage restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // If ?location= is in the URL (from SHARE), pre-fill the input.
    (function () {
      try {
        const s = new URLSearchParams(window.location.search).get('location');
        if (s) document.getElementById('location-input').value = s;
      } catch(e) {}
    })();

    // Restore last location from localStorage (URL param takes precedence).
    (function () {
      try {
        const params = new URLSearchParams(window.location.search);
        if (!params.get('location')) {
          const saved = localStorage.getItem('location');
          if (saved) {
            const { name, lat, lon } = JSON.parse(saved);
            locationName = name.toUpperCase();
            locationLat  = lat;
            locationLon  = lon;
            document.getElementById('location-input').value = name;
            document.getElementById('location-display').textContent = locationName;
          }
        }
      } catch(e) {}
    })();


    // â”€â”€ Haversine distance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Great-circle distance between two lat/lon points, in km.
    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }


    // â”€â”€ Lookup tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // ICAO callsign prefix â†’ airline name (e.g. "QFA001" â†’ "QANTAS")
    const AIRLINE_DB = {
      QFA:'QANTAS',         VOZ:'VIRGIN AUSTRALIA', JST:'JETSTAR',
      RXA:'REX',            NWL:'NETWORK AVIATION',
      UAE:'EMIRATES',       ETD:'ETIHAD',            QTR:'QATAR AIRWAYS',
      SIA:'SINGAPORE AIR',  MAS:'MALAYSIA AIRLINES', CPA:'CATHAY PACIFIC',
      ANZ:'AIR NEW ZEALAND',FJI:'FIJI AIRWAYS',      THA:'THAI AIRWAYS',
      THY:'TURKISH AIRLINES',GIA:'GARUDA',           PAL:'PHILIPPINE AIR',
      AIQ:'THAI AIRASIA X', XAX:'AIRASIA X',         VNA:'VIETNAM AIRLINES',
      EVA:'EVA AIR',        CCA:'AIR CHINA',         CSN:'CHINA SOUTHERN',
      CES:'CHINA EASTERN',  KAL:'KOREAN AIR',        AAR:'ASIANA',
      ANA:'ANA',            JAL:'JAPAN AIRLINES',    AAL:'AMERICAN AIRLINES',
      UAL:'UNITED AIRLINES',DAL:'DELTA AIR LINES',   ACA:'AIR CANADA',
      BAW:'BRITISH AIRWAYS',AFR:'AIR FRANCE',        DLH:'LUFTHANSA',
      HAL:'HAWAIIAN AIRLINES',
    };
    function airlineFromCallsign(cs) {
      if (!cs || cs === '---') return '---';
      const prefix = cs.match(/^[A-Z]+/)?.[0] || '';
      return AIRLINE_DB[prefix] || prefix || '---';
    }

    // ADS-B emitter category codes â†’ plain English
    const CATEGORY_DB = {
      A1:'LIGHT', A2:'SMALL', A3:'LARGE', A4:'B757 CLASS', A5:'HEAVY',
      A6:'HIGH PERF', A7:'ROTORCRAFT', B1:'GLIDER', B2:'AIRSHIP',
      B4:'SKYDIVER', B6:'UAV', B7:'SPACECRAFT', C1:'GROUND VEH',
    };

    // ICAO type codes â†’ full model names (e.g. "B789" â†’ "B787-9")
    const AIRCRAFT_TYPE_DB = {
      B737:'B737-700', B738:'B737-800', B739:'B737-900', B73X:'B737-900ER',
      B37M:'B737 MAX 7', B38M:'B737 MAX 8', B39M:'B737 MAX 9', B3XM:'B737 MAX 10',
      B752:'B757-200', B753:'B757-300',
      B762:'B767-200', B763:'B767-300', B764:'B767-400',
      B772:'B777-200', B77L:'B777-200LR', B773:'B777-300', B77W:'B777-300ER',
      B778:'B777X-8',  B779:'B777X-9',
      B788:'B787-8',   B789:'B787-9',   B78X:'B787-10',
      B712:'B717-200', B721:'B727-100', B722:'B727-200',
      B741:'B747-100', B742:'B747-200', B743:'B747-300', B744:'B747-400', B748:'B747-8',
      A318:'A318', A319:'A319', A320:'A320', A321:'A321',
      A19N:'A319neo', A20N:'A320neo', A21N:'A321neo', A21X:'A321XLR',
      A332:'A330-200', A333:'A330-300', A338:'A330-800neo', A339:'A330-900neo',
      A342:'A340-200', A343:'A340-300', A345:'A340-500', A346:'A340-600',
      A359:'A350-900', A35K:'A350-1000',
      A380:'A380', A388:'A380-800',
      E170:'E170', E175:'E175', E190:'E190', E195:'E195',
      E75L:'E175-E2', E290:'E190-E2', E295:'E195-E2',
      CRJ2:'CRJ-200', CRJ7:'CRJ-700', CRJ9:'CRJ-900', CRJX:'CRJ-1000',
      DH8A:'DASH 8-100', DH8B:'DASH 8-200', DH8C:'DASH 8-300', DH8D:'DASH 8-400',
      AT43:'ATR 42-300', AT45:'ATR 42-500', AT72:'ATR 72-200', AT75:'ATR 72-500', AT76:'ATR 72-600',
      BCS1:'A220-100', BCS3:'A220-300',
      SF34:'SAAB 340', SB20:'SAAB 2000', JS41:'JETSTREAM 41',
      PC12:'PILATUS PC-12', C208:'CESSNA CARAVAN',
      GL5T:'GULFSTREAM G550', GLEX:'GLOBAL EXPRESS', GLF6:'GULFSTREAM G650',
      C25A:'CITATION CJ2', C25B:'CITATION CJ3', C68A:'CITATION SOVEREIGN',
      FA7X:'FALCON 7X', FA8X:'FALCON 8X',
      C130:'C-130 HERCULES', C17:'C-17 GLOBEMASTER', P8:'P-8 POSEIDON',
      EC35:'H135', EC45:'H145', S76:'SIKORSKY S-76', AS32:'SUPER PUMA',
      B06:'BELL 206', B407:'BELL 407',
    };

    // Combines type code + emitter category into one readable string.
    // e.g. type="B789", category="A5" â†’ "B787-9 (HEAVY)"
    function formatType(t, category) {
      const typeCode = (t || '').toUpperCase();
      const cat      = (category || '').toUpperCase();
      const fullName = AIRCRAFT_TYPE_DB[typeCode];
      const catLabel = CATEGORY_DB[cat];
      if (fullName && catLabel) return fullName + ' (' + catLabel + ')';
      if (fullName)             return fullName;
      if (typeCode && catLabel) return typeCode + ' (' + catLabel + ')';
      if (typeCode)             return typeCode;
      if (catLabel)             return catLabel;
      return cat || '---';
    }


    // â”€â”€ Formatting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Emergency squawk codes â€” displayed in red with âš 
    const EMERG_SQUAWKS = { '7700':'MAYDAY', '7600':'NORDO', '7500':'HIJACK' };
    function formatSquawk(sqk) {
      if (!sqk || sqk === '---') return '---';
      const emerg = EMERG_SQUAWKS[sqk];
      if (emerg) return '<span style="color:#ff2020;text-shadow:0 0 8px #ff0000;">' + sqk + ' \u26a0 ' + emerg + '</span>';
      return sqk;
    }

    // Above 10,000ft â†’ Flight Level notation; below â†’ feet QNH
    function formatAlt(alt) {
      if (typeof alt !== 'number') return '---';
      if (alt >= 10000) return 'FL' + String(Math.round(alt / 100)).padStart(3, '0');
      return alt.toLocaleString() + ' FT QNH';
    }


    // â”€â”€ Flight phase detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Classifies aircraft by altitude + vertical speed.
    // Returns { label, color, cls } for the UI and colour bleed effect.
    function flightPhase(f) {
      const alt  = typeof f.alt_baro  === 'number' ? f.alt_baro  : null;
      const vspd = typeof f.baro_rate === 'number' ? f.baro_rate : 0;
      if (alt === null) return { label: '---', color: null, cls: '' };
      if (alt < 3000) {
        if (vspd < -200) return { label: 'â–¼ LANDING',    color: '#ff6060', cls: 'phase-landing' };
        if (vspd >  200) return { label: 'â–² TAKING OFF', color: '#60ff90', cls: 'phase-takeoff' };
        if (vspd < -50)  return { label: '~ APPROACH',   color: '#ffcc40', cls: 'phase-approach' };
      }
      if (vspd < -100) return { label: 'â–¼ DESCENDING', color: '#ff9040', cls: 'phase-descending' };
      if (vspd >  100) return { label: 'â–² CLIMBING',   color: '#60ff90', cls: 'phase-climbing' };
      return { label: 'â”€â”€ OVERHEAD', color: null, cls: '' };
    }


    // â”€â”€ Sound â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Synthesised radar ping via Web Audio API â€” no audio files needed.
    // AudioContext created on first user interaction (browser autoplay policy).
    let audioCtx = null;
    let soundOn  = false;

    function toggleSound() {
      soundOn = !soundOn;
      const btn = document.getElementById('sound-btn');
      btn.textContent = soundOn ? 'ðŸ”Š SND' : 'ðŸ”‡ SND';
      btn.classList.toggle('active', soundOn);
      if (soundOn && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playPing() {
      if (!soundOn || !audioCtx) return;
      const osc  = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.3);
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }


    // â”€â”€ Share URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Copies a ?location= link to clipboard; opening it auto-geocodes on load.
    function shareUrl() {
      const url = new URL(window.location.href);
      url.searchParams.set('location', document.getElementById('location-input').value.trim() || locationName);
      const str = url.toString();
      const btn = document.querySelector('button[onclick="shareUrl()"]');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(str).then(() => {
          const orig = btn.textContent;
          btn.textContent = 'âœ“ COPIED';
          setTimeout(() => btn.textContent = orig, 2000);
        });
      } else {
        prompt('Copy this link:', str);
      }
    }


    // â”€â”€ Session log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Records every unique aircraft (by hex) seen this session. Newest first.
    const sessionLog = new Map(); // hex â†’ { call, type, timeStr, phase }

    function logFlight(f, phase) {
      const hex = f.hex || f.r || '';
      if (!hex || sessionLog.has(hex)) return;
      const call    = (f.flight || '---').trim().toUpperCase();
      const type    = formatType(f.t, f.category);
      const now     = new Date();
      const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
      sessionLog.set(hex, { call, type, timeStr, phase: phase.label });
      renderLog();
    }

    function renderLog() {
      const list    = document.getElementById('log-list');
      const count   = document.getElementById('log-count');
      const entries = Array.from(sessionLog.values()).reverse();
      count.textContent = entries.length;
      if (!entries.length) { list.innerHTML = '<span style="opacity:0.4">No flights recorded yet.</span>'; return; }
      list.innerHTML = entries.map(e =>
        '<div class="log-entry">' +
        '<span style="opacity:0.5">' + e.timeStr + '</span> ' +
        '<strong>' + e.call + '</strong> ' + e.type +
        ' <span style="opacity:0.6">' + e.phase + '</span></div>'
      ).join('');
    }


    // â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let map, acMarker, acLine, acVector, acArrowHead, geofenceCircle, locationMarker;

    function initMap() {
      map = L.map('dm-map', { zoomControl: false }).setView([20, 0], 2); // world view until location is set
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap Â© Carto', maxZoom: 14
      }).addTo(map);
    }

    // Draws or repositions the location marker + geofence ring.
    // Reuses existing layers to avoid flicker.
    function updateGeofenceCircle() {
      const t = THEMES[currentTheme];
      if (geofenceCircle) {
        geofenceCircle.setLatLng([locationLat, locationLon]);
        geofenceCircle.setRadius(geofenceKm * 1000); // Leaflet uses metres
      } else {
        geofenceCircle = L.circle([locationLat, locationLon], {
          radius: geofenceKm * 1000, color: t.main, fillColor: t.main,
          fillOpacity: 0.05, weight: 1, dashArray: '5 5'
        }).addTo(map);
      }
      if (locationMarker) {
        locationMarker.setLatLng([locationLat, locationLon]);
        locationMarker.getTooltip().setContent(locationName);
      } else {
        locationMarker = L.circleMarker([locationLat, locationLon], {
          radius: 5, color: '#ffffff', fillColor: '#ffffff', fillOpacity: 0.9, weight: 2
        }).addTo(map).bindTooltip(locationName, { permanent: true, direction: 'right', className: 'dm-callout' });
      }
      map.setView([locationLat, locationLon], 11);
    }

    function clearAircraftMarker() {
      if (acMarker)    { acMarker.remove();    acMarker = null; }
      if (acLine)      { acLine.remove();      acLine = null; }
      if (acVector)    { acVector.remove();    acVector = null; }
      if (acArrowHead) { acArrowHead.remove(); acArrowHead = null; }
    }

    // Returns a lat/lon point distKm away in direction bearingDeg (spherical trig).
    function destPoint(lat, lon, bearingDeg, distKm) {
      const R = 6371, d = distKm / R, brng = bearingDeg * Math.PI / 180;
      const lat1 = lat * Math.PI / 180, lon1 = lon * Math.PI / 180;
      const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d) + Math.cos(lat1)*Math.sin(d)*Math.cos(brng));
      const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
      return [lat2 * 180/Math.PI, lon2 * 180/Math.PI];
    }

    // Places/moves the aircraft dot, dashed line to location, and
    // a speed-scaled heading vector with chevron arrowhead.
    function updateMap(lat, lon, callsign, groundSpeedKt, trackDeg) {
      const pos = [lat, lon];
      const t   = THEMES[currentTheme];

      // Aircraft dot
      if (acMarker) {
        acMarker.setLatLng(pos);
        acMarker.getTooltip().setContent(callsign);
      } else {
        acMarker = L.circleMarker(pos, { radius: 7, color: t.acMarker, fillColor: t.acMarker, fillOpacity: 1, weight: 2 })
          .addTo(map).bindTooltip(callsign, { permanent: true, direction: 'top', className: 'dm-callout' });
      }

      // Dashed line to location centre
      if (acLine) acLine.setLatLngs([pos, [locationLat, locationLon]]);
      else acLine = L.polyline([pos, [locationLat, locationLon]], { color: t.main, weight: 1, opacity: 0.4, dashArray: '4 6' }).addTo(map);

      // Speed-scaled heading vector + arrowhead (100kt=1km, clamped 0.5â€“8km)
      if (typeof groundSpeedKt === 'number' && groundSpeedKt > 0 && typeof trackDeg === 'number') {
        const vectorKm  = Math.max(0.5, Math.min(groundSpeedKt / 100, 8));
        const tip       = destPoint(lat, lon, trackDeg, vectorKm);
        const headKm    = vectorKm * 0.28;
        const leftWing  = destPoint(tip[0], tip[1], (trackDeg + 180 - 28 + 360) % 360, headKm);
        const rightWing = destPoint(tip[0], tip[1], (trackDeg + 180 + 28) % 360, headKm);
        const vs        = { color: t.acMarker, weight: 2, opacity: 0.7 };
        if (acVector) {
          acVector.setLatLngs([pos, tip]);
          acArrowHead.setLatLngs([leftWing, tip, rightWing]);
        } else {
          acVector    = L.polyline([pos, tip], vs).addTo(map);
          acArrowHead = L.polyline([leftWing, tip, rightWing], vs).addTo(map);
        }
      } else {
        if (acVector)    { acVector.remove();    acVector = null; }
        if (acArrowHead) { acArrowHead.remove(); acArrowHead = null; }
      }

      map.fitBounds(L.latLngBounds([pos, [locationLat, locationLon]]).pad(0.3));
    }


    // â”€â”€ Altitude bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Maps 0â€“45,000ft to a 0â€“100% CSS height on the right-edge bar.
    function updateAltBar(alt) {
      const fill = document.getElementById('alt-bar-fill');
      if (typeof alt !== 'number') { fill.style.height = '0%'; return; }
      fill.style.height = Math.min(100, Math.max(0, (alt / 45000) * 100)) + '%';
    }


    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Formats and displays all data for one aircraft from the API.
    // Key API fields: flight, r (reg), t (type), hex, lat, lon,
    //                 alt_baro (ft), gs (kt), baro_rate (fpm), track (Â°), squawk, category

    let prevTopHex = null; // used to detect when the #1 aircraft changes (triggers ping)

    function render(f) {
      const ctr     = '[' + (flightIndex+1) + '/' + flights.length + ']';
      const distLoc = haversineKm(locationLat, locationLon, f.lat, f.lon);
      const altStr  = formatAlt(f.alt_baro);
      const spd     = f.gs        ? Math.round(f.gs) + ' KT' : '---';
      const vs      = f.baro_rate ? (f.baro_rate > 0 ? '+' : '') + f.baro_rate + ' FPM' : '---';
      const hdg     = f.track     ? Math.round(f.track) + 'Â°' : '---';
      const call    = (f.flight || '---').trim().toUpperCase();
      const typeStr = formatType(f.t, f.category);
      const reg     = (f.r || '---').toUpperCase();
      const sqkStr  = formatSquawk(f.squawk || '---');
      const airline = airlineFromCallsign(call);

      // Callsign links to FlightAware
      const callLink = call !== '---'
        ? '<a href="https://www.flightaware.com/live/flight/' + call + '" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">' + call + '</a>'
        : '---';

      const phase     = flightPhase(f);
      const phaseHtml = phase.color
        ? '<span style="color:' + phase.color + ';text-shadow:0 0 8px ' + phase.color + ';">' + phase.label + '</span>'
        : phase.label;

      document.getElementById('info-wrap').className = phase.cls || '';

      document.getElementById('info').innerHTML =
        'FLIGHT&nbsp;&nbsp; ' + callLink + '<br>' +
        'REG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + reg + '<br>' +
        'TYPE&nbsp;&nbsp;&nbsp;&nbsp; ' + typeStr + '<br>' +
        'AIRLINE&nbsp; ' + airline + '<br>' +
        'PHASE&nbsp;&nbsp;&nbsp; ' + phaseHtml;

      document.getElementById('main').innerHTML =
        'ALT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + altStr + '<br>' +
        'SPEED&nbsp;&nbsp;&nbsp; ' + spd + '<br>' +
        'V/SPEED&nbsp; ' + vs + '<br>' +
        'GND TRK&nbsp; ' + hdg + '<br>' +
        'DIST LOC&nbsp; ' + distLoc.toFixed(1) + ' KM<br>' +
        'SQUAWK&nbsp;&nbsp; ' + sqkStr;

      document.getElementById('counter').textContent = ctr;
      updateAltBar(f.alt_baro);

      // Play ping when a new aircraft becomes #1 closest
      if (flightIndex === 0 && f.hex !== prevTopHex) {
        if (prevTopHex !== null) playPing();
        prevTopHex = f.hex;
      }

      logFlight(f, phase);
      fetchPhoto(reg, f.hex || '', (f.t || '').toUpperCase());
      updateMap(f.lat, f.lon, call, f.gs, f.track);
    }


    // â”€â”€ Photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Fetches from Planespotters.net by hex/reg. Caches last reg to avoid re-fetching.
    let lastPhotoReg = null;

    async function fetchPhoto(reg, hex, type) {
      if (!reg || reg === '---') { clearPhoto(); return; }
      if (reg === lastPhotoReg)  return;
      lastPhotoReg = reg;
      clearPhoto();
      try {
        const res = await fetch(
          'https://api.planespotters.net/pub/photos/hex/' + hex + '?reg=' + reg + '&icaoType=' + type,
          { signal: AbortSignal.timeout(6000) }
        );
        if (!res.ok) return;
        const data  = await res.json();
        const photo = data.photos && data.photos[0];
        if (!photo) return;
        const src    = photo.thumbnail_large?.src || photo.thumbnail?.src;
        const credit = photo.photographer ? 'Â© ' + photo.photographer : '';
        if (src) setPhoto(src, credit);
      } catch(e) {}
    }

    function setPhoto(src, credit) {
      document.getElementById('dm-photo').src = src;
      document.getElementById('photo-wrap').style.display = 'block';
      document.getElementById('dm-photo-credit').textContent = credit;
    }
    function clearPhoto() {
      document.getElementById('dm-photo').src = '';
      document.getElementById('photo-wrap').style.display = 'none';
    }


    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function go(n) { if (flights.length) { flightIndex = (n + flights.length) % flights.length; render(flights[flightIndex]); } }
    function next() { go(flightIndex + 1); }
    function prev() { go(flightIndex - 1); }
    function manualRefresh() { secs = 15; fetchFlights(); }


    // â”€â”€ Auto-refresh timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let secs = 15;
    setInterval(() => {
      if (!locationLat && !locationLon) return;
      secs--;
      document.getElementById('refresh-timer').textContent = 'REFRESH IN ' + secs + 'S';
      if (secs <= 0) fetchFlights();
    }, 1000);


    // â”€â”€ Geocoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Converts any location string to lat/lon via Nominatim (OSM).
    // Works worldwide â€” no country restriction.
    async function geocodeLocation(name) {
      const url = 'https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(name) + '&format=json&limit=1';
      const res = await fetch(url, { signal: AbortSignal.timeout(8000), headers: { 'Accept-Language': 'en' } });
      if (!res.ok) throw new Error('Geocoding request failed');
      const data = await res.json();
      if (!data.length) throw new Error('Location not found: ' + name);
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function setLocation() {
      const input = document.getElementById('location-input').value.trim();
      if (!input) return;
      document.getElementById('error').textContent = 'LOCATING ' + input.toUpperCase() + '...';
      try {
        const { lat, lon } = await geocodeLocation(input);
        locationName = input.toUpperCase();
        locationLat  = lat;
        locationLon  = lon;
        document.getElementById('location-display').textContent = locationName;
        document.getElementById('error').textContent = '';
        lastPhotoReg = null;
        prevTopHex   = null;
        clearAircraftMarker();
        updateGeofenceCircle();
        try { localStorage.setItem('location', JSON.stringify({ name: input, lat, lon })); } catch(e) {}
        await fetchFlights();
      } catch(e) {
        document.getElementById('error').textContent = 'LOCATION ERR: ' + e.message;
      }
    }


    // â”€â”€ Fetch flights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Queries airplanes.live, filters to geofence + alt floor, sorts by distance.
    // Aborts any in-progress request first to prevent stale data overwrites.
    async function fetchFlights() {
      if (fetchController) fetchController.abort();
      fetchController = new AbortController();
      const signal = fetchController.signal;
      document.getElementById('info').textContent  = 'FETCHING DATA...';
      document.getElementById('error').textContent = '';
      try {
        const res = await fetch(
          'http://192.168.x.x:3000/flights?lat=' + locationLat + '&lon=' + locationLon + '&radius=' + apiRadiusNm(),
          { signal }
        );
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        let ac = (data.ac || []).filter(f =>
          typeof f.alt_baro === 'number' && f.alt_baro >= altFloorFt &&
          f.lat && f.lon &&
          haversineKm(locationLat, locationLon, f.lat, f.lon) <= geofenceKm
        );
        ac.sort((a, b) =>
          haversineKm(locationLat, locationLon, a.lat, a.lon) -
          haversineKm(locationLat, locationLon, b.lat, b.lon)
        );
        if (!ac.length) {
          clearAircraftMarker(); clearPhoto();
          document.getElementById('info').textContent    = 'NO AIRCRAFT ABOVE ' + locationName + '.';
          document.getElementById('main').textContent    = '';
          document.getElementById('counter').textContent = '';
          document.getElementById('info-wrap').className = '';
          updateAltBar(null);
          return;
        }
        flights = ac; flightIndex = 0;
        render(flights[0]);
      } catch(e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        document.getElementById('error').textContent = 'ERR: ' + e.message;
        document.getElementById('info').textContent  = '^ SEE ABOVE';
      } finally {
        secs = 15; // always reset countdown after each fetch attempt
      }
    }


    // â”€â”€ Keyboard navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Arrow keys browse flights; suppressed while typing in the location input.
    document.addEventListener('keydown', e => {
      if (document.activeElement === document.getElementById('location-input')) return;
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft')  prev();
    });
    document.getElementById('location-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') setLocation();
    });


    // â”€â”€ Sliders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Each slider restores its saved value on load, then updates state + localStorage on drag.
    // They do NOT trigger an API fetch â€” the next 15s refresh picks up the new value.

    // Geofence
    (function () {
      try {
        const saved = parseInt(localStorage.getItem('geofenceKm'), 10);
        if (saved >= 2 && saved <= 20) {
          geofenceKm = saved;
          document.getElementById('geofence-slider').value = saved;
          document.getElementById('geofence-label').textContent = saved + ' KM';
        }
      } catch(e) {}
    })();
    document.getElementById('geofence-slider').addEventListener('input', function () {
      geofenceKm = parseInt(this.value, 10);
      document.getElementById('geofence-label').textContent = geofenceKm + ' KM';
      if (geofenceCircle) updateGeofenceCircle();
      try { localStorage.setItem('geofenceKm', geofenceKm); } catch(e) {}
    });

    // Altitude floor
    (function () {
      try {
        const saved = parseInt(localStorage.getItem('altFloorFt'), 10);
        if (saved >= 200 && saved <= 5000) {
          altFloorFt = saved;
          document.getElementById('altfloor-slider').value = saved;
          document.getElementById('altfloor-label').textContent = saved + ' FT';
        }
      } catch(e) {}
    })();
    document.getElementById('altfloor-slider').addEventListener('input', function () {
      altFloorFt = Math.max(200, parseInt(this.value, 10));
      document.getElementById('altfloor-label').textContent = altFloorFt + ' FT';
      try { localStorage.setItem('altFloorFt', altFloorFt); } catch(e) {}
    });


    // â”€â”€ Share link: auto-geocode on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // If opened with ?location= (via SHARE button), geocode it automatically.
    // Small delay ensures the map is initialised before setLocation() runs.
    (function () {
      const s = new URLSearchParams(window.location.search).get('location');
      if (s) setTimeout(() => setLocation(), 50);
    })();


    // â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    initMap();
    if (locationLat !== 0 || locationLon !== 0) fetchFlights(); // only fetch if a location is set
    else document.getElementById('info').textContent = 'ENTER A LOCATION TO BEGIN.';

  </script>
</body>
</html>
